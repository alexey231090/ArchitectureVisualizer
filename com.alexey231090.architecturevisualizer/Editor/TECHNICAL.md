# Техническая документация

## Архитектура плагина

### Основные компоненты

#### 1. ArchitectureVisualizerWindow
Главное окно плагина, реализующее интерфейс пользователя.

**Основные функции:**
- Создание и управление вкладками
- Анализ проекта
- Отображение структуры проекта
- Детальный анализ скриптов
- Поддержка вложенных типов
- Отображение значений массивов и коллекций

**Ключевые методы:**
- `CreateGUI()` - создание интерфейса
- `AnalyzeProject()` - анализ проекта
- `UpdateScriptDetails()` - обновление деталей скриптов
- `UpdateProjectStructure()` - обновление структуры проекта
- `GetFieldValue()` - получение значения поля с поддержкой вложенных типов

#### 2. ScriptAnalyzer
Компонент для анализа скриптов проекта.

**Основные функции:**
- Анализ зависимостей между скриптами
- Определение типов полей
- Анализ использования компонентов
- Поддержка вложенных типов
- Анализ массивов и коллекций

**Ключевые методы:**
- `AnalyzeScripts()` - анализ всех скриптов
- `GetFieldValue()` - получение значения поля
- `AnalyzeFieldUsage()` - анализ использования поля
- `ProcessNestedTypes()` - обработка вложенных типов
- `ProcessCollections()` - обработка коллекций

#### 3. ProjectStructureView
Компонент для отображения структуры проекта.

**Основные функции:**
- Отображение иерархии папок
- Группировка скриптов
- Навигация по структуре

**Ключевые методы:**
- `UpdateStructure()` - обновление структуры
- `CreateFolderElement()` - создание элемента папки
- `CreateScriptElement()` - создание элемента скрипта

#### 4. ScriptDetailsView
Компонент для детального анализа скриптов.

**Основные функции:**
- Отображение полей скрипта
- Показ текущих значений
- Анализ использования полей
- Поддержка вложенных типов
- Отображение значений коллекций

**Ключевые методы:**
- `UpdateDetails()` - обновление деталей
- `CreateFieldElement()` - создание элемента поля
- `ShowFieldValue()` - отображение значения поля
- `ProcessNestedType()` - обработка вложенного типа
- `ProcessCollection()` - обработка коллекции

### Структура данных

#### ScriptInfo
```csharp
public class ScriptInfo
{
    public string Name { get; set; }
    public string Path { get; set; }
    public List<FieldInfo> Fields { get; set; }
    public List<string> Dependencies { get; set; }
    public List<Type> NestedTypes { get; set; }
}
```

#### FieldInfo
```csharp
public class FieldInfo
{
    public string Name { get; set; }
    public Type Type { get; set; }
    public object Value { get; set; }
    public bool IsPublic { get; set; }
    public bool IsNested { get; set; }
    public Type DeclaringType { get; set; }
}
```

### UI Компоненты

#### Вкладки
1. **Tables**
   - Таблицы с зависимостями
   - Фильтрация и сортировка
   - Экспорт данных

2. **Structure**
   - Древовидное отображение
   - Группировка по папкам
   - Навигация

3. **Script Details**
   - Список скриптов
   - Детали полей
   - Текущие значения
   - Вложенные типы
   - Значения коллекций

### Стилизация

#### Основные стили
```css
.unity-base-field {
    margin: 5px;
    padding: 5px;
}

.unity-base-field__label {
    color: #E1E1E1;
}

.unity-base-field__input {
    background-color: #383838;
    border-color: #505050;
}
```

#### Стили для вкладок
```css
.tab {
    padding: 10px;
    margin: 5px;
    background-color: #2D2D2D;
    border-radius: 4px;
}

.tab-content {
    padding: 10px;
    margin-top: 5px;
}
```

### Обработка ошибок

#### Основные типы ошибок
1. **Ошибки анализа**
   - Недоступные скрипты
   - Неподдерживаемые типы
   - Ошибки компиляции
   - Проблемы с вложенными типами

2. **Ошибки UI**
   - Отсутствующие ресурсы
   - Проблемы с отображением
   - Ошибки стилизации

#### Обработка ошибок
```csharp
try {
    // Код, который может вызвать ошибку
} catch (Exception ex) {
    Debug.LogError($"Ошибка: {ex.Message}");
    // Обработка ошибки
}
```

### Производительность

#### Оптимизации
1. **Кэширование**
   - Кэширование результатов анализа
   - Кэширование значений полей
   - Кэширование структуры проекта
   - Кэширование вложенных типов

2. **Ленивая загрузка**
   - Загрузка данных по требованию
   - Отложенная инициализация
   - Асинхронная загрузка

3. **Ограничения**
   - Максимальное количество скриптов
   - Максимальная глубина анализа
   - Таймауты операций

### Расширяемость

#### Точки расширения
1. **Анализаторы**
   - Добавление новых типов анализа
   - Расширение существующих анализаторов
   - Кастомные правила анализа
   - Поддержка новых типов коллекций

2. **Визуализация**
   - Новые типы отображения
   - Кастомные стили
   - Дополнительные фильтры
   - Улучшенное отображение коллекций

3. **Экспорт**
   - Новые форматы экспорта
   - Кастомные шаблоны
   - Дополнительные метаданные

### Безопасность

#### Основные аспекты
1. **Доступ к данным**
   - Проверка прав доступа
   - Валидация входных данных
   - Безопасное хранение

2. **Обработка ошибок**
   - Логирование ошибок
   - Восстановление после сбоев
   - Защита от утечек

3. **Конфиденциальность**
   - Защита конфиденциальных данных
   - Шифрование при необходимости
   - Безопасная передача данных

## Техническая заметка: кириллица в EditorWindow

- Для поддержки кириллицы используется шрифт Roboto (ttf) и явное применение его к Label/TextField.
- В Label кириллица отображается корректно, но в TextField на Windows возможны баги с прямым вводом.
- Копипаст работает всегда, а также можно использовать EditorUtility.DisplayDialog для обхода проблемы.

#### Обход бага с кириллицей: кнопка "Рус"
В окнах для ввода комментариев и описаний добавлена кнопка "Рус". При её активации вводимые символы с английской раскладки автоматически конвертируются в русские буквы с помощью функции `ConvertToRussianLayout`. Пользователь может не переключать системную раскладку Windows — достаточно нажать "Рус" и печатать на английской, а текст будет отображаться по-русски. Это полностью устраняет баг Unity с некорректным вводом кириллицы в TextField. 

## Event Tracking (актуализация)

### Архитектура
- EventTrackingManager — хранение и управление всеми цепочками (paths) и шагами (steps)
- ArchitectureVisualizerWindow — вкладка Event Tracking, UI для управления путями и шагами
- AddPathWindow, EditPathWindow, AddStepWindow — модальные окна для добавления/редактирования путей и шагов

### Возможности
- Добавление/редактирование/удаление путей и шагов
- Выбор скрипта и переменной для каждого шага
- Многострочные комментарии
- Английский интерфейс
- Поддержка кириллицы (работает "из коробки")
- Поддержка массивов, коллекций, множественных экземпляров объектов
- Подсветка изменений (fade/highlight) — TODO
- Реальное время обновления значений — TODO
- Устойчивость к ошибкам (NullReference и др.)

### Known Issues
- Подсветка изменений и реальное время обновления Event Tracking — в процессе восстановления
- Возможны баги с отображением некоторых типов переменных

### TODO
- Восстановить подсветку изменений (fade/highlight)
- Восстановить обновление значений в реальном времени
- Доработать поддержку массивов, коллекций, множественных экземпляров
- Провести тестирование и оптимизацию 